---
import { app } from "@/firebase/server";
import { getAuth } from "firebase-admin/auth";

import Layout from "@/layouts/Dashboard.astro";

import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

const auth = getAuth(app);

/* Check current session */
if (!Astro.cookies.has("__session")) {
  return Astro.redirect("/signin");
}

const sessionCookie = Astro.cookies.get("__session")?.value || "N/A";
const decodedCookie = await auth.verifySessionCookie(sessionCookie);
const user = await auth.getUser(decodedCookie.uid);

if (!user) {
  return Astro.redirect("/signin");
}
---

<Layout title="Campaigns">
  <div class="grid gap-6">
    <Card>
      <CardHeader>
        <CardTitle>Cargar usuarios</CardTitle>
      </CardHeader>
      <CardContent>
        <form id="uploadForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2"
              >Usuarios (uno por l√≠nea)</label
            >
            <Textarea
              id="usersList"
              name="users"
              placeholder={"Juan Perez,juan@example.com\nMaria Lopez,maria@example.com"}
            />
          </div>
          <Button type="submit">Cargar usuarios</Button>
        </form>
      </CardContent>
    </Card>
  </div>
</Layout>

<script>
  document
    .getElementById("uploadForm")!
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const textarea = document.getElementById(
        "usersList"
      ) as HTMLTextAreaElement;

      const users = textarea.value
        .split("\n")
        .filter((line) => line.trim())
        .map((line) => {
          const [name, email] = line.split(",").map((s) => s.trim());
          return { name, email };
        });

      try {
        const response = await fetch("/api/phishingUsers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(users),
        });

        if (response.ok) {
          location.reload();
        }
      } catch (error) {
        console.error("Error:", error);
      }
    });
</script>
